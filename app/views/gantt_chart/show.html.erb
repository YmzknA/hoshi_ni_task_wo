<!-- app/views/gantt_chart/show.html.erb -->
<div class="container mx-auto p-4 text-gray-100">
  <h1 class="text-2xl font-bold mb-6 text-white">垂直ガントチャート</h1>
  
  <div id="gantt_chart" class="h-[85vh] overflow-auto border rounded-lg shadow-sm border-gray-700 bg-gray-800/90">
    <div class="flex min-w-full w-max">

      <!-- 日付列 -->
      <div class="sticky left-0 w-[60px] border-r border-gray-700 bg-gray-800 relative z-60">

        <!-- 日付ヘッダー - 固定 -->
        <div class="sticky top-0 h-14 flex items-center justify-center font-medium border-b border-gray-700 bg-gray-900/70 z-60">
          日付
        </div>
        <div class="flex flex-col z-60">
          <% @date_range.each_with_index do |date, index| %>
            <div class="h-[40px] flex items-center justify-center text-sm border-b border-gray-700/70 <%= (date.wday == 0) || (date.wday == 1) ? 'bg-error/70' : '' %>">
              <%= date.strftime("%m/%d") %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- ガントチャート本体 -->
      <div class="flex-grow relative">
        <!-- ヘッダー行 - 星座名 (固定) -->
        <div class="sticky top-0 h-14 flex z-50 w-full">
          <% @milestones.each do |milestone| %>
            <%
              # 色の設定
              milestone_color = milestone.color
            %>
          <div class="border border-3 rounded-md text-gray-100 text-xl absolute flex items-center justify-center font-medium px-2 text-center bg-opacity-50"
              style="
              width: <%= @milestone_widths[milestone.id] %>px;
              left: <%= @milestone_lefts[milestone.id].to_i %>px;
              top: 0; height: 100%;
              background-color: <%= milestone_color %>b3;
              border-color: <%= milestone_color %>cc;
              ">
              <%= milestone.title %>
            </div>
          <% end %>
        </div>

        <div class="relative">
          <!-- 日付ごとの行 -->
          <div>
          <% @date_range.each_with_index do |date, index| %>
            <div
              class="h-[40px] border-b border-gray-700 z-30
                     <%= index == 0 ? 'border-t' : '' %>
                     <%= (date.wday == 0) || (date.wday == 1) ? 'bg-error/20' : '' %>"
              style="width: max(<%= @chart_total_width %>px, 100%);"
            >
            <!-- @chart_total_width：日付の横線のサイズを指定している -->
            <!-- 100%にすると、画面幅以上のチャートになった際に日付線が画面幅で切れてしまう -->
            <!-- この行には何も表示しない（背景色のみ） -->
            </div>
          <% end %>
          </div>

          <!-- milestone（長方形） -->
        <% @milestones.each do |milestone| %>
          <% 
            start_index = @date_range.index { |d| d.to_date == milestone.start_date.to_date }
            end_index = @date_range.index { |d| d.to_date == milestone.end_date.to_date }
            milestone_height = (end_index - start_index + 1) * 40
            milestone_top = start_index * 40
            
            # milestoneチャートの幅と位置
            milestone_width = @milestone_widths[milestone.id]
            milestone_left = @milestone_lefts[milestone.id]
            
            # 色の設定(taskもこの色を使う)
            milestone_color = milestone.color
          %>

          <!-- milestone名前 -->
          <div class="absolute border-3 rounded-md flex flex-col items-center cursor-pointer z-30" 
            style="top: <%= milestone_top - 30 %>px; 
            height: 35px; 
            width: <%= milestone_width.to_i - 20 %>px; 
            left: <%= milestone_left.to_i + 10 %>px;
            background-color: <%= milestone_color %>cc;
            border-color: <%= milestone_color %>cc;
            ">

            <%= milestone.title %>
          </div>

          <!-- milestone本体（長方形） -->
          <div class="absolute border-3 rounded-md flex flex-col items-center"
               style="top: <%= milestone_top %>px; 
                      height: <%= milestone_height %>px; 
                      width: <%= milestone_width %>px; 
                      left: <%= milestone_left.to_i %>px;
                      background-color: <%= milestone_color %>50;
                      border-color: <%= milestone_color %>cc;
                      ">
            
            <!-- Task（丸と線） -->
            <!-- valid_datesでstart_dateかend_dateが無いtaskを弾く -->
            <% milestone.tasks.valid_dates.each_with_index do |task, task_index| %>
              <%
                # taskがmilestoneの期間内にあるか確認
                # 無ければ表示しない
                if task.start_date >= milestone.start_date && task.end_date <= milestone.end_date

                  # task_xxx_index：taskの表示はmilestoneの四角の上辺を始点に始まっているため、start_indexを引く
                  task_start_index = @date_range.index { |d| d.to_date == task.start_date.to_date } - start_index
                  task_end_index = @date_range.index { |d| d.to_date == task.end_date.to_date } - start_index
                  task_height = (task_end_index - task_start_index + 1) * 40
                  task_top = task_start_index * 40
                  margin_top = 8
                  
                  # taskの水平位置を計算
                  # section_wdthでtask一つあたりの占有割合を出す
                  # task_leftで現在のtaskがこのmilestoneの何%の位置か設定
                  section_width = 100.0 / (milestone.tasks.count + 1)
                  task_left = "calc(#{section_width * (task_index + 1)}%)"
                %>

              <!-- heightの-5は上下につける〇の要素のサイズ分 -->
                <div class="absolute flex flex-col items-center task-container cursor-pointer"
                     style="top: <%= task_top + margin_top %>px; 
                            height: <%= task_height - (margin_top * 2) - 5 %>px; 
                            left: <%= task_left %>;">
                  
                  <!-- 開始点の円 -->
                  <div class="w-4 h-4 rounded-full z-40" style="background-color: <%= milestone_color %>;"></div>
                  
                  <!-- 線 -->
                  <div class="w-1 flex-grow z-40" style="background-color: <%= milestone_color %>;"></div>
                  
                  <!-- 終了点の円 -->
                  <div class="w-4 h-4 rounded-full z-40" style="background-color: <%= milestone_color %>;"></div>
                </div>
              <% end %>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>


